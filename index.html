<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªèª­ã¿ä¸Šã’ã‚µã‚¤ãƒˆ</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
        }
        /* ã‚«ãƒ†ã‚´ãƒªãƒˆã‚°ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .category-toggle-icon {
            transition: transform 0.2s ease-in-out;
        }
        .category-toggle-icon.rotate-180 {
            transform: rotate(180deg);
        }
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º */
        .user-menu-dropdown {
            position: absolute;
            top: 100%; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸‹ã«é…ç½® */
            right: 0;
            z-index: 10;
            min-width: 180px; /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æœ€å°å¹… */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 relative">
    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="absolute top-4 right-4 z-20">
        <button id="userMenuButton" class="bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ (ä¾‹ã¨ã—ã¦ğŸ‘¤ã‚’ä½¿ç”¨) -->
            <span class="text-2xl">ğŸ‘¤</span>
        </button>
        <div id="userMenuDropdown" class="user-menu-dropdown bg-gray-800 p-4 rounded-lg shadow-xl hidden">
            <p id="authStatus" class="text-gray-200 text-sm mb-3 text-center"></p>
            <button id="googleSignInButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button id="signOutButton" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 hidden">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>
    </div>

    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-3xl font-bold text-center text-gray-100 mb-6">è‹±èªèª­ã¿ä¸Šã’ã‚µã‚¤ãƒˆ</h1>

        <div class="mb-6">
            <label for="textInput" class="block text-gray-200 text-sm font-semibold mb-2">
                èª­ã¿ä¸Šã’ãŸã„è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:
            </label>
            <textarea id="textInput" class="w-full p-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y bg-gray-700 text-gray-100" rows="6" placeholder="ä¾‹: Hello, how are you today?

This is a text-to-speech example with a pause between paragraphs."></textarea>
        </div>

        <!-- é€Ÿåº¦èª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
        <div class="mb-6">
            <label for="rateInput" class="block text-gray-200 text-sm font-semibold mb-2">
                èª­ã¿ä¸Šã’é€Ÿåº¦: <span id="rateValue" class="text-gray-100">1.0</span>
            </label>
            <input type="range" id="rateInput" min="0.5" max="2" value="1" step="0.1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- ãƒªãƒ”ãƒ¼ãƒˆè¨­å®š -->
        <div class="mb-6">
            <label for="repeatCount" class="block text-gray-200 text-sm font-semibold mb-2">
                ãƒªãƒ”ãƒ¼ãƒˆè¨­å®š:
            </label>
            <select id="repeatCount" class="w-full p-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                <option value="infinite">ç„¡é™</option>
                <option value="1">1å›</option>
                <option value="2">2å›</option>
                <option value="3">3å›</option>
                <option value="5">5å›</option>
                <option value="10">10å›</option>
            </select>
        </div>

        <div class="flex mb-4">
            <button id="readAloudButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                èª­ã¿ä¸Šã’ã‚‹
            </button>
        </div>

        <!-- ä¿å­˜æ©Ÿèƒ½ -->
        <div class="mt-8 pt-4 border-t border-gray-700">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">è‹±æ–‡ã‚’ä¿å­˜</h2>
            <div class="mb-4">
                <label for="textTitleInput" class="block text-gray-200 text-sm font-semibold mb-2">
                    ã‚¿ã‚¤ãƒˆãƒ«:
                </label>
                <input type="text" id="textTitleInput" class="w-full p-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-gray-700 text-gray-100" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
            </div>
            <button id="saveTextButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                è‹±æ–‡ã‚’ä¿å­˜
            </button>
        </div>

        <!-- ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡ã®è¡¨ç¤º -->
        <div class="mt-8 pt-4 border-t border-gray-700">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡</h2>
            <!-- ä¸¦ã¹æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="mb-4">
                <label for="sortOrder" class="block text-gray-200 text-sm font-semibold mb-2">
                    ä¸¦ã¹æ›¿ãˆ:
                </label>
                <select id="sortOrder" class="w-full p-3 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-gray-100">
                    <option value="newest">æ–°ã—ã„é †</option>
                    <option value="oldest">å¤ã„é †</option>
                    <option value="titleAsc">ã‚¿ã‚¤ãƒˆãƒ«é † (æ˜‡é †)</option>
                    <option value="titleDesc">ã‚¿ã‚¤ãƒˆãƒ«é † (é™é †)</option>
                </select>
            </div>
            <p id="userIdDisplay" class="text-gray-400 text-sm mb-4"></p>
            <div id="savedTextsContainer" class="space-y-4">
                <!-- ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                <p class="text-gray-400 text-center" id="loadingMessage">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="customConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p class="text-lg font-semibold text-gray-100 mb-4" id="confirmMessage"></p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-gray-200 rounded-md transition duration-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="okConfirmBtn" class="px-4 py-2 bg-red-700 hover:bg-red-800 text-white rounded-md transition duration-200">OK</button>
                </div>
            </div>
        </div>

        <div id="messageBox" class="mt-4 p-3 bg-red-900 border border-red-700 text-red-300 rounded-lg hidden" role="alert">
            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- Firebase SDKã‚’èª­ã¿è¾¼ã‚€ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOMè¦ç´ ã‚’å–å¾—
        const textInput = document.getElementById('textInput');
        const readAloudButton = document.getElementById('readAloudButton');
        const rateInput = document.getElementById('rateInput');
        const rateValueSpan = document.getElementById('rateValue');
        const messageBox = document.getElementById('messageBox');
        const textTitleInput = document.getElementById('textTitleInput');
        const saveTextButton = document.getElementById('saveTextButton');
        const savedTextsContainer = document.getElementById('savedTextsContainer');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingMessage = document.getElementById('loadingMessage');
        const repeatCountSelect = document.getElementById('repeatCount');
        const sortOrderSelect = document.getElementById('sortOrder'); // ä¸¦ã¹æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³

        // Googleèªè¨¼é–¢é€£ã®DOMè¦ç´ 
        const userMenuButton = document.getElementById('userMenuButton');
        const userMenuDropdown = document.getElementById('userMenuDropdown');
        const googleSignInButton = document.getElementById('googleSignInButton');
        const signOutButton = document.getElementById('signOutButton');
        const authStatusDisplay = document.getElementById('authStatus');

        let db;
        let auth;
        let userId = 'anonymous'; // åˆæœŸå€¤
        let currentUtterance = null; // ç¾åœ¨ã®èª­ã¿ä¸Šã’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿æŒ

        // æ®µè½èª­ã¿ä¸Šã’ç®¡ç†å¤‰æ•°
        let currentParagraphs = []; // Array of { utterance, text } objects for the queue
        let currentParagraphIndex = 0;
        let isSpeechActive = false; // True if speech is ongoing or paused (managed by our queue)
        let currentRepeatIteration = 0; // ç¾åœ¨ã®ãƒªãƒ”ãƒ¼ãƒˆå›æ•°
        let totalRepeatCount = 0; // è¨­å®šã•ã‚ŒãŸãƒªãƒ”ãƒ¼ãƒˆç·æ•° (0 = ç„¡é™)

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            if (type === 'error') {
                messageBox.className = 'mt-4 p-3 bg-red-900 border border-red-700 text-red-300 rounded-lg';
            } else if (type === 'info') {
                messageBox.className = 'mt-4 p-3 bg-blue-900 border border-blue-700 text-blue-300 rounded-lg';
            } else if (type === 'success') {
                messageBox.className = 'mt-4 p-3 bg-green-900 border border-green-700 text-green-300 rounded-lg';
            }
            messageBox.classList.remove('hidden');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹é–¢æ•°
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateReadAloudButtonState() {
            if (window.speechSynthesis.speaking) {
                if (window.speechSynthesis.paused) {
                    readAloudButton.textContent = 'å†é–‹';
                    readAloudButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    readAloudButton.classList.add('bg-orange-600', 'hover:bg-orange-700');
                } else {
                    readAloudButton.textContent = 'ä¸€æ™‚åœæ­¢';
                    readAloudButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    readAloudButton.classList.add('bg-orange-600', 'hover:bg-orange-700');
                }
            } else {
                readAloudButton.textContent = 'èª­ã¿ä¸Šã’ã‚‹';
                readAloudButton.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                readAloudButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        // Firebaseã®åˆæœŸåŒ–ã¨èªè¨¼
        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼çŠ¶æ…‹ã®å¤‰æ›´ã‚’ç›£è¦–
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (user.isAnonymous) {
                            authStatusDisplay.textContent = `åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼`;
                            userIdDisplay.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`;
                            googleSignInButton.classList.remove('hidden');
                            signOutButton.classList.add('hidden');
                        } else {
                            authStatusDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email}`;
                            userIdDisplay.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}`; // Googleãƒ­ã‚°ã‚¤ãƒ³ã§ã‚‚UIDã¯è¡¨ç¤º
                            googleSignInButton.classList.add('hidden');
                            signOutButton.classList.remove('hidden');
                        }
                        console.log("Authenticated user ID:", userId);
                        // èªè¨¼å®Œäº†å¾Œã«ä¿å­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
                        loadSavedTexts();
                    } else {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸå ´åˆã€ã¾ãŸã¯åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆ
                        authStatusDisplay.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
                        userIdDisplay.textContent = ''; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ã‚¯ãƒªã‚¢
                        googleSignInButton.classList.remove('hidden');
                        signOutButton.classList.add('hidden');
                        // __initial_auth_token ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°åŒ¿åèªè¨¼
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            console.log("No initial auth token. Waiting for user action or session restore.");
                            userId = crypto.randomUUID(); // ä»®ã®åŒ¿åID
                            userIdDisplay.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId} (ä»®)`;
                            loadSavedTexts(); // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªãŒæ­£ã—ãå‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚", "error");
            }
        }

        // Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹é–¢æ•°
        async function signInWithGoogle() {
            hideMessage();
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚', 'success');
                userMenuDropdown.classList.add('hidden'); // ãƒ­ã‚°ã‚¤ãƒ³å¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                let errorMessage = 'Googleãƒ­ã‚°ã‚¤ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Googleãƒ­ã‚°ã‚¤ãƒ³ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'æ—¢ã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚Œã¦ã„ã¾ã™ã€‚';
                }
                showMessage(errorMessage, 'error');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹é–¢æ•°
        async function signOutUser() {
            hideMessage();
            try {
                // ç¾åœ¨ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
                window.speechSynthesis.cancel();
                isSpeechActive = false;
                currentUtterance = null;
                currentParagraphs = [];
                currentParagraphIndex = 0;
                currentRepeatIteration = 0;
                updateReadAloudButtonState();

                await signOut(auth);
                showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚', 'info');
                // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€åŒ¿åèªè¨¼ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                await signInAnonymously(auth);
                userMenuDropdown.classList.add('hidden'); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
            } catch (error) {
                console.error("Sign Out Error:", error);
                showMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        }


        // æ®µè½ã‚’é †ã«èª­ã¿ä¸Šã’ã‚‹å†å¸°é–¢æ•°
        function speakParagraphs() {
            // isSpeechActiveãŒfalseã®å ´åˆï¼ˆå¤–éƒ¨ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆãªã©ï¼‰ã€ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†ã‚’åœæ­¢
            if (!isSpeechActive) {
                console.log("Speech queue cancelled externally.");
                currentUtterance = null;
                updateReadAloudButtonState();
                currentParagraphs = [];
                currentParagraphIndex = 0;
                currentRepeatIteration = 0;
                return;
            }

            // ç¾åœ¨ã®æ®µè½ãŒãã®ãƒªãƒ”ãƒ¼ãƒˆã‚µã‚¤ã‚¯ãƒ«ã®æœ€å¾Œã®æ®µè½ã«åˆ°é”ã—ãŸå ´åˆ
            if (currentParagraphIndex >= currentParagraphs.length) {
                currentRepeatIteration++; // ãƒªãƒ”ãƒ¼ãƒˆå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                console.log(`Finished iteration ${currentRepeatIteration}`);

                // ç„¡é™ãƒªãƒ”ãƒ¼ãƒˆã§ãªã„ã€ã‹ã¤è¨­å®šã•ã‚ŒãŸãƒªãƒ”ãƒ¼ãƒˆå›æ•°ã«é”ã—ãŸå ´åˆ
                if (totalRepeatCount !== 0 && currentRepeatIteration >= totalRepeatCount) {
                    showMessage('èª­ã¿ä¸Šã’ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'info');
                    currentUtterance = null;
                    isSpeechActive = false;
                    updateReadAloudButtonState();
                    currentParagraphs = [];
                    currentParagraphIndex = 0;
                    currentRepeatIteration = 0;
                    return;
                } else {
                    // æ¬¡ã®ãƒªãƒ”ãƒ¼ãƒˆã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹
                    currentParagraphIndex = 0; // æ®µè½ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    // ãƒªãƒ”ãƒ¼ãƒˆé–“ã®ãƒãƒ¼ã‚º
                    setTimeout(() => {
                        speakParagraphs(); // æ¬¡ã®ãƒªãƒ”ãƒ¼ãƒˆã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹
                    }, 1000); // ãƒªãƒ”ãƒ¼ãƒˆé–“ã®ãƒãƒ¼ã‚ºæ™‚é–“ï¼ˆ1ç§’ï¼‰
                    return;
                }
            }

            const { utterance, text } = currentParagraphs[currentParagraphIndex];
            currentUtterance = utterance; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªcurrentUtteranceã‚’ç¾åœ¨èª­ã¿ä¸Šã’ä¸­ã®ã‚‚ã®ã«è¨­å®š

            utterance.onend = function() {
                console.log(`Finished speaking paragraph ${currentParagraphIndex + 1} in iteration ${currentRepeatIteration + 1}: "${text.substring(0, Math.min(text.length, 30))}..."`);
                // èª­ã¿ä¸Šã’ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ã¿æ¬¡ã®æ®µè½ã¸é€²ã‚€
                if (isSpeechActive) {
                    // æ¬¡ã®æ®µè½ã®å‰ã«ãƒãƒ¼ã‚ºã‚’æŒ¿å…¥
                    setTimeout(() => {
                        currentParagraphIndex++;
                        speakParagraphs(); // æ¬¡ã®æ®µè½ã‚’èª­ã¿ä¸Šã’
                    }, 700); // æ®µè½é–“ã®ãƒãƒ¼ã‚ºã®æ™‚é–“ï¼ˆãƒŸãƒªç§’å˜ä½ã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                }
            };

            utterance.onerror = function(event) {
                console.error('SpeechSynthesisUtterance.onerror for paragraph:', event);
                showMessage('èª­ã¿ä¸Šã’ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + event.error, 'error');
                currentUtterance = null;
                isSpeechActive = false;
                updateReadAloudButtonState();
                currentParagraphs = [];
                currentParagraphIndex = 0;
                currentRepeatIteration = 0;
            };

            window.speechSynthesis.speak(utterance);
            updateReadAloudButtonState(); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ã€Œä¸€æ™‚åœæ­¢ã€ã«æ›´æ–°
        }


        // èª­ã¿ä¸Šã’å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•° (ä¸€æ™‚åœæ­¢/å†é–‹æ©Ÿèƒ½ã‚’å«ã‚€)
        function readAloud() {
            hideMessage();
            const inputText = textInput.value.trim();
            const rate = parseFloat(rateInput.value);
            const selectedRepeat = repeatCountSelect.value;

            if (inputText === '') {
                showMessage('èª­ã¿ä¸Šã’ã‚‹è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!('speechSynthesis' in window)) {
                showMessage('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆAPIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chromeã‚„Firefoxã‚’ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ç¾åœ¨èª­ã¿ä¸Šã’ä¸­ã§ä¸€æ™‚åœæ­¢çŠ¶æ…‹ã§ãªã„å ´åˆã€ä¸€æ™‚åœæ­¢ã™ã‚‹
            if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
                window.speechSynthesis.pause();
                updateReadAloudButtonState();
                showMessage('èª­ã¿ä¸Šã’ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸã€‚', 'info');
                return;
            }

            // ç¾åœ¨ä¸€æ™‚åœæ­¢ä¸­ã®å ´åˆã€å†é–‹ã™ã‚‹
            if (window.speechSynthesis.paused) {
                window.speechSynthesis.resume();
                updateReadAloudButtonState();
                showMessage('èª­ã¿ä¸Šã’ã‚’å†é–‹ã—ã¾ã—ãŸã€‚', 'info');
                return;
            }

            // èª­ã¿ä¸Šã’ä¸­ã§ãªã„ã€ã¾ãŸã¯åœæ­¢ä¸­ã®å ´åˆã€æ–°ã—ã„èª­ã¿ä¸Šã’ã‚’é–‹å§‹ã™ã‚‹
            // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚„ã‚­ãƒ¥ãƒ¼å†…ã®ã™ã¹ã¦ã®ç™ºè©±ã‚’å³åº§ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            window.speechSynthesis.cancel();
            currentUtterance = null; // ä»¥å‰ã®ç™ºè©±å‚ç…§ã‚’ã‚¯ãƒªã‚¢
            currentParagraphs = []; // ä»¥å‰ã®æ®µè½ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            currentParagraphIndex = 0;
            currentRepeatIteration = 0; // ãƒªãƒ”ãƒ¼ãƒˆå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            isSpeechActive = true; // æ–°ã—ã„ã‚­ãƒ¥ãƒ¼ã®ãŸã‚ã«èª­ã¿ä¸Šã’ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¨ã—ã¦ãƒãƒ¼ã‚¯

            // ãƒªãƒ”ãƒ¼ãƒˆè¨­å®šã‚’æ•°å€¤ã«å¤‰æ›
            if (selectedRepeat === 'infinite') {
                totalRepeatCount = 0; // 0ã¯ç„¡é™ãƒªãƒ”ãƒ¼ãƒˆã‚’ç¤ºã™
            } else {
                totalRepeatCount = parseInt(selectedRepeat, 10);
            }

            // 2ã¤ä»¥ä¸Šã®æ”¹è¡Œæ–‡å­—ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’æ®µè½ã«åˆ†å‰²
            const paragraphs = inputText.split(/\n{2,}/).filter(p => p.trim() !== '');

            if (paragraphs.length === 0) {
                showMessage('èª­ã¿ä¸Šã’ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                isSpeechActive = false; // èª­ã¿ä¸Šã’ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãªã„
                updateReadAloudButtonState(); // ãƒœã‚¿ãƒ³ãŒã€Œèª­ã¿ä¸Šã’ã‚‹ã€çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                return;
            }

            // å„æ®µè½ã«å¯¾ã—ã¦SpeechSynthesisUtteranceã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
            paragraphs.forEach(paragraphText => {
                const utterance = new SpeechSynthesisUtterance(paragraphText.trim());
                utterance.lang = 'en-US';
                utterance.rate = rate;
                utterance.pitch = 1;
                currentParagraphs.push({ utterance: utterance, text: paragraphText.trim() });
            });

            speakParagraphs(); // ã‚­ãƒ¥ãƒ¼ã®æœ€åˆã®æ®µè½ã®èª­ã¿ä¸Šã’ã‚’é–‹å§‹
            // èª­ã¿ä¸Šã’ãŒå®Ÿéš›ã«é–‹å§‹ã•ã‚ŒãŸã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®é…å»¶ãƒã‚§ãƒƒã‚¯
            setTimeout(() => {
                // çŸ­ã„é…å»¶å¾Œã‚‚èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤ã‚­ãƒ¥ãƒ¼ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã€ä½•ã‚‰ã‹ã®å•é¡ŒãŒç™ºç”Ÿ
                if (!window.speechSynthesis.speaking && isSpeechActive) {
                    showMessage('èª­ã¿ä¸Šã’ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®å•é¡Œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚', 'error');
                    // èª­ã¿ä¸Šã’é–‹å§‹ã«å¤±æ•—ã—ãŸå ´åˆã€çŠ¶æ…‹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    isSpeechActive = false;
                    currentUtterance = null;
                    currentParagraphs = [];
                    currentParagraphIndex = 0;
                    currentRepeatIteration = 0;
                    updateReadAloudButtonState();
                }
            }, 200);
        }

        // è‹±æ–‡ã‚’Firestoreã«ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveText() {
            hideMessage();
            const text = textInput.value.trim();
            const title = textTitleInput.value.trim(); // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—

            if (text === '') {
                showMessage('ä¿å­˜ã™ã‚‹è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            if (title === '') {
                showMessage('è‹±æ–‡ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!db || !userId) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'error');
                return;
            }

            try {
                const textsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/spoken_texts`);
                await addDoc(textsCollectionRef, {
                    text: text,
                    // Firestoreã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿äº’æ›æ€§ã®ãŸã‚'category'ã®ã¾ã¾
                    category: title, // UIä¸Šã¯ã‚¿ã‚¤ãƒˆãƒ«ã ãŒã€DBä¸Šã¯categoryã¨ã—ã¦ä¿å­˜
                    timestamp: serverTimestamp() // ã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
                });
                showMessage('è‹±æ–‡ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
                textTitleInput.value = ''; // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('è‹±æ–‡ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        // ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function loadSavedTexts() {
            if (!db || !userId) {
                // FirebaseãŒã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                return;
            }

            const textsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/spoken_texts`);
            const q = query(textsCollectionRef); // orderByã¯ä½¿ç”¨ã›ãšã€JavaScriptã§ã‚½ãƒ¼ãƒˆ

            onSnapshot(q, (snapshot) => {
                savedTextsContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                loadingMessage.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º

                if (snapshot.empty) {
                    savedTextsContainer.innerHTML = '<p class="text-gray-400 text-center">ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                const texts = [];
                snapshot.forEach((doc) => {
                    texts.push({ id: doc.id, ...doc.data() });
                });

                // ä¸¦ã¹æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
                const sortOrder = sortOrderSelect.value;
                texts.sort((a, b) => {
                    if (sortOrder === 'newest') {
                        const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                        const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                        return timeB - timeA; // é™é †
                    } else if (sortOrder === 'oldest') {
                        const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                        const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                        return timeA - timeB; // æ˜‡é †
                    } else if (sortOrder === 'titleAsc') {
                        const titleA = (a.category || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—').toLowerCase();
                        const titleB = (b.category || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—').toLowerCase();
                        return titleA.localeCompare(titleB); // æ˜‡é †
                    } else if (sortOrder === 'titleDesc') {
                        const titleA = (a.category || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—').toLowerCase();
                        const titleB = (b.category || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—').toLowerCase();
                        return titleB.localeCompare(titleA); // é™é †
                    }
                    return 0;
                });

                // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—§ã‚«ãƒ†ã‚´ãƒªï¼‰ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const categorizedTexts = texts.reduce((acc, item) => {
                    // UIä¸Šã¯ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æ‰±ã†ãŒã€DBã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯'category'ã®ã¾ã¾
                    const title = item.category || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—';
                    if (!acc[title]) {
                        acc[title] = [];
                    }
                    acc[title].push(item);
                    return acc;
                }, {});

                // ã‚¿ã‚¤ãƒˆãƒ«ã¨è‹±æ–‡ã‚’è¡¨ç¤º
                for (const title in categorizedTexts) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-gray-700 p-3 rounded-lg mb-4';
                    categoryDiv.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-100 flex justify-between items-center cursor-pointer category-header">
                            ${title}
                            <span class="text-gray-400 text-sm transform transition-transform duration-200 category-toggle-icon">â–¼</span>
                        </h3>
                        <div class="texts-in-category hidden mt-2 space-y-2"></div> <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚’æ ¼ç´ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã€æœ€åˆã¯éè¡¨ç¤º -->
                    `;
                    const textsInThisCategoryDiv = categoryDiv.querySelector('.texts-in-category');
                    const toggleIcon = categoryDiv.querySelector('.category-toggle-icon');

                    // ã‚¿ã‚¤ãƒˆãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                    categoryDiv.querySelector('.category-header').addEventListener('click', () => {
                        textsInThisCategoryDiv.classList.toggle('hidden');
                        toggleIcon.classList.toggle('rotate-180'); // çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’å›è»¢
                    });

                    categorizedTexts[title].forEach(item => {
                        const textItemDiv = document.createElement('div');
                        textItemDiv.className = 'bg-gray-600 p-3 rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between';
                        textItemDiv.innerHTML = `
                            <p class="text-gray-200 text-sm flex-grow mb-2 sm:mb-0">${item.text.substring(0, 50)}${item.text.length > 50 ? '...' : ''}</p> <!-- è‹±æ–‡ã®å†’é ­50æ–‡å­—ã‚’è¡¨ç¤º -->
                            <div class="flex space-x-2 mt-2 sm:mt-0">
                                <button data-text="${item.text}" class="view-saved-text-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded-md transition duration-200">è¡¨ç¤º</button>
                                <button data-id="${item.id}" class="delete-saved-text-btn bg-red-700 hover:bg-red-800 text-white text-xs px-3 py-1 rounded-md transition duration-200">å‰Šé™¤</button>
                            </div>
                        `;
                        textsInThisCategoryDiv.appendChild(textItemDiv);
                    });
                    savedTextsContainer.appendChild(categoryDiv);
                }

                // ã€Œè¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                document.querySelectorAll('.view-saved-text-btn').forEach(button => {
                    button.onclick = (event) => {
                        textInput.value = event.target.dataset.text; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å…¨æ–‡ã‚’ã‚»ãƒƒãƒˆ
                        hideMessage(); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                        // ã“ã“ã§ã¯è‡ªå‹•ã§èª­ã¿ä¸Šã’ã¯é–‹å§‹ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ã‚¤ãƒ³ã®ã€Œèª­ã¿ä¸Šã’ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹
                    };
                });

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                document.querySelectorAll('.delete-saved-text-btn').forEach(button => {
                    button.onclick = (event) => {
                        const docId = event.target.dataset.id;
                        showCustomConfirm('ã“ã®è‹±æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', async () => {
                            await deleteText(docId);
                        });
                    };
                });
            }, (error) => {
                console.error("Error fetching documents: ", error);
                showMessage('ä¿å­˜ã•ã‚ŒãŸè‹±æ–‡ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
                loadingMessage.classList.add('hidden');
                savedTextsContainer.innerHTML = '<p class="text-gray-400 text-center">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            });
        }

        // è‹±æ–‡ã‚’Firestoreã‹ã‚‰å‰Šé™¤ã™ã‚‹é–¢æ•°
        async function deleteText(docId) {
            hideMessage();
            if (!db || !userId) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'error');
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/spoken_texts`, docId);
                await deleteDoc(docRef);
                showMessage('è‹±æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage('è‹±æ–‡ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        // ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’txtãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function downloadText() {
            hideMessage();
            const text = textInput.value.trim();
            if (text === '') {
                showMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹è‹±æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'spoken_text.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // URLã‚’è§£æ”¾
            showMessage('è‹±æ–‡ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', 'info');
        }

        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('confirmMessage').textContent = message;
            modal.classList.remove('hidden');

            const okBtn = document.getElementById('okConfirmBtn');
            const cancelBtn = document.getElementById('cancelConfirmBtn');

            const cleanup = () => {
                okBtn.onclick = null;
                cancelBtn.onclick = null;
                modal.classList.add('hidden');
            };

            okBtn.onclick = () => {
                onConfirm();
                cleanup();
            };

            cancelBtn.onclick = () => {
                cleanup();
            };
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        readAloudButton.addEventListener('click', readAloud);
        saveTextButton.addEventListener('click', saveText);
        rateInput.addEventListener('input', () => {
            rateValueSpan.textContent = rateInput.value;
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        userMenuButton.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('hidden');
        });

        // Googleèªè¨¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        googleSignInButton.addEventListener('click', signInWithGoogle);
        signOutButton.addEventListener('click', signOutUser);

        // ä¸¦ã¹æ›¿ãˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´æ™‚ã«å†èª­ã¿è¾¼ã¿
        sortOrderSelect.addEventListener('change', loadSavedTexts);

        // Firebaseã®åˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’é–‹å§‹
        initializeFirebase();
    </script>
</body>
</html>
